## 1.WAF串联部署

攻击队会使用某OA的0day漏洞、某CMS的0day漏洞、框架级0day漏洞（Fastjson、Dubbo、Thinkphp）、**中间件级别的0day漏洞（Weblogic、Websphere）**等植入一个webshell或者内存马，然后做Socks5代理攻击内网。

绕过WAF方式：

>**1.** 使用超大数据包或者脏数据包使waf放行。
>
>**2.** 使用畸形数据包使waf的正则表达式识别不了。
>
>**3.** 利用协议解析问题中间件解析特性使waf识别不了但是中间件可以解析等各种方法绕过waf的防护。
>
>**4.** 在最近的攻防比赛中，对于Java反序列化漏洞的绕waf的数据包，更加偏向于使其看起来像正常业务的流量数据，以绕过流量监控的检查。

处理策略：**用两个不同厂商的waf进行串联，这样攻击者费尽心力构造一个绕waf的数据包，可以绕过一个厂商的waf，但是难以同时绕过两个厂商的waf**

缺点：两个不同厂商的waf串联，在部分场合会影响业务的正常运行，所以要在业务低峰期，进行一下测试与评估

## 2.终端安全防护多元化

使用两个不同品牌的EDR/HIDS/杀软进行防护：

1. **防止攻击队拥有该品牌的0day漏洞导致整体无告警**
2. **防止一个品牌的edr终端防护被轻易绕过**

缺点：两个不同品牌的edr可能会不兼容，出现相互“打架”的问题。

## 3.资产管理和暴露面收紧

做好前期的资产收集工作，**将无用的老旧系统通通下线，对一些无需对外开放的系统，可以收缩到内网访问，或者通过VPN进行访问**。尤其是一些OA系统、记账系统、工单系统、报表系统、CMS系统，尽量收到内网之后；因为这些系统广泛使用，各家攻击队可能会掌握其大量代码，审计出0day漏洞，导致直接被打穿。

## 4.主机外联全面封禁

**不仅仅要封禁TCP端口的外连，UDP端口同样也需要封堵，尤其是UDP的53端口；此外，DNS协议、ICMP协议要同样封堵，因为攻击队的反向代理隧道可以伪装成DNS协议、ICMP协议、UDP协议以绕过传统防火墙的拦截**

目前的Java应用的反序列化漏洞，为了绕过各种限制通常**需要反向连接RMI服务端，因此封禁主机外连可以切断0day漏洞的利用路径，解决部分0day漏洞的攻击**。比如说当年的核弹级别的Log4j2等0day漏洞，就需要出网才能利用，大面积整改漏洞需要研发测试，可能耗费一个月的时间，那么限制出网会是一个非常好的策略。如果部分业务确实有出网需求，**那么可以加上白名单访问控制策略**。

**优点：**为攻击者的内网横向带来很大阻力，极大减慢攻击者内网横移的速度，逼迫攻击者使用速度慢且不稳定的HTTP隧道代理，或者使用真正的端口复用程序。

**缺点：**防不了以内存马形式植入的HTTP隧道代理，防不了真正的端口复用程序。好在这两种方式搭建代理都不太稳定。

## 5.内网邮箱防钓鱼策略

**公司邮箱强制要求只能在内网使用或者登录VPN之后才可以收发邮件，从根源上彻底封堵邮件钓鱼的可能性**

**缺点：**1、对于一个甲方公司来讲，已经习惯了十多年的外网邮箱使用，为了网络安全去推进这个防守措施，难度极大，部分公司可能会无法推进。2、通过VPN登录内网邮箱很麻烦，员工为了使用方便，逐步出现了大量使用自己原有的个人邮箱126、163邮箱、qq邮箱来存储公司的办公文件或excel密码列表的现象，反而带来了其它的安全隐患。

## 6.密码安全与弱口令

所以攻防演练比赛之前，一般会要求运维人员或者公司员工，对自己的外网密码、内网服务器密码、网络设备密码等等都需要修改一遍。**除了防止弱口令的问题之外，还要防止前期红队人员在长期对一家单位进行红队评估过程中，逐步积累的一些该公司的密码规律**。所有员工尤其是运维人员，都要清空浏览器的自动记录密码功能，防止攻击者对员工进行邮件钓鱼，导致浏览器记录的密码完全被抓到，导致VPN密码被抓到，直接内网沦陷。

**1、研发源头限制**。研发人员在写注册密码功能代码的时候，就需要从根源上限制用户设置的密码复杂度足够高，至少8位、涵盖大小写及特殊字符等，并且禁止键盘连号。

**2、双因子认证**。外网或者内网的业务系统，使用用户名密码登录入口统一可以添加短信认证，并且杜绝逻辑漏洞导致短信验证可以绕过的问题，同时也要进行万能验证码的情况发生。

## 7.一到两次的前期红队评估检验

所有的防守体系搭建完成之后，一定要邀请不同公司的红队进行红队评估，实战演练可以对防守体系进行查漏补缺。

通过实战打一遍，可以得知是否还有未下线的老旧资产、攻击流量是否都流经了安全设备、全流量设备是否存下了攻击流量、探针部署是否合理、内网蜜罐是否告警、蜜罐是否进行了有效的网络隔离、EDR的各种防护模块是否开启并进行了有效拦截、一些漏洞是否得到了有效修复等等。**只有经过实战的红队评估检验，这些容易被疏忽的问题才会显露出来**。

## 8.指纹信息监控与告警

**1、漏洞测试工具的指纹信息：**主要包括Burpsuite的证书或者流量特征、Fiddler的证书或者流量特征、Burpsuite的替代品Yakit、抓包工具Charles的证书或者流量特征。这些代理抓包工具都是红队人员人手一份的，对这些指纹信息进行告警会极大增加红队人员的测试难度。

**2、常见的dnslog域名：**攻击队员在探测一些Java反序列化漏洞、一些0day漏洞的时候，通常会用dnslog方法进行测试。这些dnslog域名包括dnslog.cn、ceye.io、burpcollaborator.net、awvsscan119.autoverify.cn等等，一旦在流量设备中发现有这些dnslog域名的访问，需要立马告警进行处理，**运气好的话，还很容易抓到0day漏洞**。

**注：**对于Fastjson反序列化漏洞，dnslog能出不一定代表其存在漏洞，因为很多较新的fastjson版本，本身就支持dnslog解析；但是如果tcp端口能出，那就100%存在漏洞了。

**3、常见的C2特征：**常用C2包括CobaltStrike远控流量特征、Metasploit的meterpreter的流量特征。根据以往的报告，有些红队人员喜欢使用meterpreter功能去横向打内网，效果也不错。

**4、代理工具特征：**攻击者在外围打点成功之后，通常会想办法架设内网代理，使用包括reGeorg、Ngrok、NPS、Frp等正向、反向socks5代理工具，这些工具的流量特征样本特征都应该入库，一旦安全设备有告警要及时处理。**最好能够自己分析自己定制一些防护规则**，因为这些工具都是开源的，对于中高级水平的红队人员来讲，做免杀或者去掉其流量特征都是可以做到的。

**5、恶意的User-Agent指纹：**这些指纹信息包括python-requests/2.24.0、Java/1.8.0_181、Go-http-client/1.1、Apache-HttpClient/4.5.13 (Java/1.8.0_251)等，这些都是红队工具常见的User-Agent指纹信息，应该重点监控重点排查

## 9.高危端口随机化

**经过总结发现，攻击者的内网横向的自动化，无论如何都绕不开扫描和利用常见的高危默认端口，当时想到的策略就是内网高危端口的随机化**，比如Redis的端口由6379改为6380、6390、16379、26379，Mysql的3306端口改为13308到13310之间、RDP的3389端口改为23388、33389等等；对于SMB的445端口、WMI的135端口难以更改的情况，那么就视情况利用操作系统自带的防火墙策略屏蔽掉。

**优点：**在国护大考的前夕，邀请不同攻击队实战检验的时候，**发现这种策略可以极大拖慢攻击队员的内网横向速度，迫使其进行全端口探测扫描**，这样的扫描行为动静非常大，非常容易触发内网的各种安全设备的告警，极大地增加了攻击行为暴露的可能性。

## 10.双向伪造指纹信息

一方面要将Weblogic、Tomcat、SSH等的指纹进行伪造，**攻击者会通过指纹去匹配自己的0day武器库**，所以隐藏指纹和版本信息，可以一定程度阻挡攻击队员对目标漏洞的识别；另一方面还要想办法**把核心的应用系统伪造成honeypot之类的蜜罐指纹**，由于攻击队员特别怕被反制或者溯源，所以遇到honeypot等蜜罐指纹，很多情况下会放弃进攻。

**伪造指纹需要根据具体情况定制化展开：1、**对于404页面、500页面，Tomcat的可以伪造成IIS的错误页面；**2、**IIS的404页面可以伪装成Weblogic或者Springboot的页面特征；**3、**Linux的22端口的指纹信息可以添加honeypot蜜罐关键字；**4、**Weblogic、Tomcat、Nginx等中间件的指纹信息，可以通过修改配置文件的方式，重点将版本号去掉，将一些特殊关键字剔除或者进行伪装；**5、**对于一些OA系统、报表系统、CMS系统，可以将一些系统的图标、css路径、png图片图形进行修改，防止被攻击队员轻易识别。

## 11.公众号、小程序、APP数据安全

他们通常会使用burpsuite、yakit、fiddler等抓包改包工具，修改一些请求参数，重点挖掘一些逻辑漏洞、越权漏洞、订单遍历漏洞、用户id遍历漏洞等，**非常容易导致几百万、上千万用户数据泄露，而这些逻辑漏洞、越权漏洞常见的WAF设备都是没办法防御的，**因为它在设备看来就是正常流量。这些小程序资产也经常会出现一些SQL注入漏洞、Fastjson反序列化漏洞、Log4j2反序列化漏洞等，在近几年的报告中，经常会发生将小程序逆向、将手机APP逆向并反编译Java代码，找到了阿里云AK/SK硬编码的问题，导致云服务器被拿下一大片的情况。

**总结：**公众号、小程序、手机APP程序虽然基本上不会导致目标单位出局或者内网被完全打穿，但是在数据安全日益重视的前提下，其逻辑漏洞会导致数据分方面失分非常严重，如果上百万、上千万数据泄露，那其危害也相当于靶标被攻破了。

## 12.VPN设备安全防护

**要求要VPN设备的用户的密码重置，防止攻击队员复用之前的VPN密码**。此外，对于VPN设备的防护，可以**通过设置异常登录时间的告警规则，增强对异常访问行为的监控**。可以监测其用户登录VPN的时间点，比如说有些VPN账号密码在半夜、凌晨登录，并且访问多个内网的业务系统，对这样的行为进行告警，第一时间下线VPN，然后进行应急处置。