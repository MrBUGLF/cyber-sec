## 1.战术

* 知己知彼：

  > 1、友方：安全设备、安全体系和安全人员，包括监控、分析研判、应急等，
  >
  > 2、敌方：要第一时间识别攻击者并作出响应
  >
  > 3、保护目标：资产摸底，互联网暴露面收敛

* 避其锋芒：防守方需要四处防护，而攻击者只需要找到一处弱点，因此封堵IP和下线系统不能手软

* 诱敌深入：蜜罐、纵深防御

* 有效联动：各类安全设备联动快速响应，安全监控和值守。HW设备套餐，设备策略优化，自动化封禁IP，人工介入弥补防御设备不足

## 2.HW设备套餐

必备：防火墙+WAF+蜜罐+威胁监测系统（流量分析回溯或态势感知类）+安全值守

豪华套餐：再加上威胁情报+主机HIDS+安全服务（渗透测试、安全监控组、分析组、处置组、报告总结组）

## 3.拦截策略优化

### 3.1 拦截事件分类

阻止会话

阻止会话并封堵IP（最好自动化封堵）

阻止会话并长期封堵IP

### 3.2 防火墙拦截策略

对来自于互联网的以下端口拦截并永久封堵（或长期封堵ip）的策略。

| 端口  | 策略 |   封堵   |
| :---: | :--: | :------: |
|  445  | 拦截 | 永久封堵 |
| 3389  | 拦截 | 永久封堵 |
| 1433  | 拦截 | 永久封堵 |
| 6379  | 拦截 | 永久封堵 |
| 2181  | 拦截 | 永久封堵 |
| 11211 | 拦截 | 永久封堵 |
| 27017 | 拦截 | 永久封堵 |
| 50070 | 拦截 | 永久封堵 |
| 11211 | 拦截 | 永久封堵 |
| 5900  | 拦截 | 永久封堵 |

对于数据中心外联互联网，一定要采取限制策略，禁止外联互联网，要采用白名单方式。

服务器外访，有个攻方常用的攻击方式，就是dns回显式注入，那么就将dnslog.cn等域名加入拦截和监控。

### 3.3 waf拦截策略

WAF在使用中最大的问题也就是**误报与漏报**,同时，waf绕过是红方必然要求的一个技能，所以在实战中，waf是必然会被绕过，但是不代表waf策略就不需要优化，那么waf策略优化可以有这么几点：

#### 3.3.1 user-agent防止扫描器

红方在踩点过程中，必然要用扫描器，连接高危端口的扫描器方式在上面的防火墙策略已经拦截，那么就开始用web应用扫描器，常见的扫描器user-agent如下，策略都是永久封堵。![图片](https://mmbiz.qpic.cn/mmbiz_png/ZIkVabbjP4H56LgtoPCYPlibQjibFZwx4h3g0n0dWEBxGqm7Uqykqic1bGG9moUf5ZNCgabVFibd2uQ5qiaCsJTHEuQ/640?wx_fmt=jpeg&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1) 

![图片](https://mmbiz.qpic.cn/mmbiz_png/ZIkVabbjP4H56LgtoPCYPlibQjibFZwx4hBvReddDfy5RkHia9AnMOXfS1FbZ5ShkeNp1kvdvPWOFO5WlsQic7XN7w/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 3.3.2 url参数中防止高危POC攻击

比如F5的远程代码执行漏洞爆发 (CVE-2020-5902)，那么我们可以将url关键字如下进行拦截，发现即封堵。

> /tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp

常见的poc攻击url特征清单如下，以下基本上发现为攻方必然扫描的url，当然有一些需要根据企业情况分析，比如我们企业没有使用php作为开发语言，那么大量php的漏洞可以直接拦截并封堵：



>/phpmyadmin
>
>/wls-wsat/CoordinatorPortType
>
>/_async/AsyncResponseService
>
>/_async/AsyncResponseServiceSoap12
>
>uddiexplorer/SearchPublicRegistries.jsp
>
>/_async/
>
>bea_wls_deployment_internal
>
>NCFindWeb?service=IPrealertConfigService&filename
>
>action=nc.ui.iufo.release.InfoReleaseAction&method=createBBSRelease&TreeSelectedID=&TableSelectedID=
>
>/uapws/service
>
>.svn/format
>
>WEB-INF/web.xml
>
>/cgi-bin/libagent.cgi
>
>/config.php
>
>fckeditor/editor/filemanager/connectors
>
>/FCKeditor/editor/filemanager/connectors/asp/connector.asp
>
>/FCKeditor/editor/filemanager/browser/default/browser.html
>
>fckeditor/editor/filemanager/connectors/test.html
>
>/secure/ContactAdministrators!default.jspa
>
>/phpinfo.php
>
>/ispirit/interface/gateway.php
>
>/weaver/bsh.servlet.BshServlet
>
>/console/
>
>/wls-wsat
>
>/solr/admin/cores?wt=json
>
>/install.txt
>
>/install.php
>
>/plugins/weathermap/editor.php
>
>/?q=node&destination=node
>
>/hedwig.cgi
>
>/device.rsp?cmd=list&opt=user
>
>/node/?_format=hal_json
>
>/_users/org.couchdb
>
>/mailsms/s?dumpConfig=%2F&func=ADMIN%3AappState
>
>mailsms/s?func=ADMIN:appState&dumpConfig=/
>
>/plus/download.php
>
>/druid/index.html
>
>org.apache.dubbo
>
>/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp

#### 3.3.3 http请求中高危特征值字段

还有一类poc，是通过http请求中包含恶意代码来执行的，比如struts2漏洞，比如fastjson漏洞，所以也需要对类似特征值进行防范,比如我们用部分包含特征样例如下：

> part="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource",part="java.lang.ProcessBuilder",part="command"
>
> 
>
> part="getRuntime",part="exec",part="java.lang.Runtime"
>
> 
>
> part="type=java.net.InetSocketAddress"
>
> 
>
> part="dataSourceName=rmi"
>
> 
>
> part="#ognlUtil=#container.getInstance(@com.opensymphony.xwork2"
>
> 
>
> part=".OgnlContext",part="DEFAULT_MEMBER_ACCESS"

#### 3.3.4 信息泄露类扫描



>/configuration/config.php
>
>/.bash_history
>
>/.git/config
>
>/.htpasswd
>
>/admin.rar
>
>/admin.sql
>
>/backup.gz
>
>/backup.rar
>
>/backup.sh
>
>/backup.sql
>
>/backup.zip
>
>/database.rar
>
>/database.sql
>
>/wwwroot.rar

### 3.4 流量监控类策略

#### 3.4.1 webshell监控

常见webshell上传中特征值如下，可以在流量监控中进行告警。

> <%execute request("
>
> 
>
> <%execute(request("
>
> 
>
> <%ExecuteGlobal request("
>
> 
>
> %><%Eval(Request(chr(
>
> 
>
> <%if(request.getParameter("
>
> 
>
> =@eval(base64_decode($_POST
>
> 
>
> class U extends ClassLoader{U(ClassLoader c
>
> 
>
> System.Text.Encoding.GetEncoding(936).GetString
>
> 
>
> com.sun.rowset.JdbcRowSetImpl
>
> 
>
> getClass().forName("java.lang.Runtime").getRuntime().exec
>
> 
>
> (#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_me

## 4. 日志统一收集并自动化处置

推荐使用日志收集系统来实现防火墙、waf、蜜罐等统一的日志收集和分析，并将攻击ip进行统一呈现，比如graylog，同时将攻击ip统一呈现还有一个好处，可以实现自动化的永久封堵，我们是通过脚本将攻击ip入库，然后脚本调用防火墙api，每5分钟实施黑名单永久封堵。

这样的好处是显而易见的，攻击者在没有摸清你的家底之前，只有通过不断的探测来摸底，但是探测过程中被你不断的封堵ip，那么他就知道碰到行家了，按照攻击队找软柿子捏的惯例，他们是不会再一个价值不高的目标花费太大的时间和精力，这个对于勒索、黑产团队也同样适用，黑产团队也是广撒网的方式来攻击，比如攻击是有成本的，只有当安全达到一定基线，那么就能够减少很多不应该的信息安全事件。

如上事情优化完成之后，就进入了安全监控、分析阶段，这个时候需要专家值守，通过全量日志分析系统，提升安全分析效率，输入第三方HW情报、自己的HW发现的问题，及时共享，联动处置。